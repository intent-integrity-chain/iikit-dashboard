<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IIKit Kanban Board</title>
  <style>
    /* ====== CSS Custom Properties ====== */
    :root {
      --color-bg: #0f1117;
      --color-surface: #1a1d27;
      --color-surface-elevated: #222536;
      --color-surface-hover: #2a2d40;
      --color-border: #2e3148;
      --color-border-subtle: #252839;
      --color-text: #e8eaed;
      --color-text-secondary: #9aa0b4;
      --color-text-muted: #6b7189;
      --color-accent: #3B82F6;
      --color-accent-hover: #60A5FA;
      --color-todo: #4a90d9;
      --color-inprogress: #f5a623;
      --color-done: #27c93f;
      --color-p1: #ff4757;
      --color-p2: #ffa502;
      --color-p3: #3498db;
      --color-verified: #27c93f;
      --color-tampered: #ff4757;
      --color-missing: #6b7189;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --shadow-card: 0 2px 8px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.2);
      --shadow-card-hover: 0 8px 24px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.3);
      --shadow-column: 0 1px 4px rgba(0,0,0,0.2);
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
      --transition-slow: 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, Oxygen, sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', monospace;
    }

    /* ====== Light Theme ====== */
    [data-theme="light"] {
      --color-bg: #f5f6f8;
      --color-surface: #ffffff;
      --color-surface-elevated: #f0f1f4;
      --color-surface-hover: #e8e9ee;
      --color-border: #d8dae0;
      --color-border-subtle: #e4e6eb;
      --color-text: #1a1d27;
      --color-text-secondary: #5a5f72;
      --color-text-muted: #8b90a0;
      --color-accent: #2563EB;
      --color-accent-hover: #3B82F6;
      --shadow-card: 0 1px 4px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-card-hover: 0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.06);
      --shadow-column: 0 1px 3px rgba(0,0,0,0.06);
    }

    /* ====== Reset & Base ====== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ====== Header ====== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 28px;
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
      gap: 16px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .feature-selector {
      position: relative;
      min-width: 100px;
      flex: 0 1 300px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: -0.3px;
      color: var(--color-text);
    }

    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--color-accent), #1D4ED8);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
      font-weight: 800;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 14px;
      flex-shrink: 0;
    }

    /* ====== Feature Selector ====== */

    .feature-selector select {
      appearance: none;
      background: var(--color-surface-elevated);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: 8px 36px 8px 12px;
      font-size: 13px;
      font-family: var(--font-sans);
      font-weight: 500;
      cursor: pointer;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
      width: 100%;
    }

    .feature-selector select:hover {
      border-color: var(--color-accent);
    }

    .feature-selector select:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    .feature-selector::after {
      content: '';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 5px solid var(--color-text-secondary);
      pointer-events: none;
    }

    /* ====== Integrity Badge ====== */
    .integrity-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      transition: all var(--transition-fast);
    }

    .integrity-badge.valid {
      background: rgba(39, 201, 63, 0.12);
      color: var(--color-verified);
      border: 1px solid rgba(39, 201, 63, 0.25);
    }

    .integrity-badge.tampered {
      background: rgba(255, 71, 87, 0.12);
      color: var(--color-tampered);
      border: 1px solid rgba(255, 71, 87, 0.25);
      animation: pulse-warning 2s ease-in-out infinite;
    }

    .integrity-badge.missing {
      background: rgba(107, 113, 137, 0.12);
      color: var(--color-missing);
      border: 1px solid rgba(107, 113, 137, 0.25);
    }

    @keyframes pulse-warning {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .integrity-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      display: inline-block;
    }

    .integrity-badge.valid .integrity-dot { background: var(--color-verified); }
    .integrity-badge.tampered .integrity-dot { background: var(--color-tampered); }
    .integrity-badge.missing .integrity-dot { background: var(--color-missing); }

    /* ====== Connection Status ====== */
    .activity-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      cursor: help;
      transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
      background-color: var(--color-text-muted);
    }

    .activity-indicator.active {
      background-color: var(--color-verified);
      box-shadow: 0 0 8px rgba(39, 201, 63, 0.6);
      animation: pulse-glow 1.5s ease-in-out infinite;
    }

    .activity-indicator.idle {
      background-color: var(--color-text-muted);
      box-shadow: none;
      animation: none;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 4px rgba(39, 201, 63, 0.4); }
      50% { box-shadow: 0 0 12px rgba(39, 201, 63, 0.8); }
    }

    /* ====== Board Layout ====== */
    .board-container {
      padding: 24px 28px;
      overflow-x: auto;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      min-width: 900px;
    }

    /* ====== Columns ====== */
    .column {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border-subtle);
      box-shadow: var(--shadow-column);
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }

    .column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 18px 12px;
      border-bottom: 1px solid var(--color-border-subtle);
    }

    .column-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--color-text-secondary);
    }

    .column-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
    }

    .column.todo .column-dot { background: var(--color-todo); }
    .column.in-progress .column-dot { background: var(--color-inprogress); }
    .column.done .column-dot { background: var(--color-done); }

    .column-count {
      background: var(--color-surface-elevated);
      color: var(--color-text-muted);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 22px;
      text-align: center;
    }

    .column-body {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    /* ====== Cards ====== */
    .card {
      background: var(--color-surface-elevated);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-card);
      transition: transform var(--transition-normal), box-shadow var(--transition-normal), opacity var(--transition-slow);
      cursor: default;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-card-hover);
      border-color: var(--color-accent);
    }

    /* Card slide animation classes */
    .card.entering {
      animation: cardEnter 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    .card.exiting {
      animation: cardExit 0.3s ease-in forwards;
    }

    @keyframes cardEnter {
      from { opacity: 0; transform: translateY(-10px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes cardExit {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(10px) scale(0.97); }
    }

    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.4;
      color: var(--color-text);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .card-title:hover {
      -webkit-line-clamp: unset;
    }

    .card-id {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--color-text-muted);
      margin-bottom: 4px;
    }

    /* ====== Priority Badges ====== */
    .priority-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    }

    .priority-badge.p1 {
      background: rgba(255, 71, 87, 0.15);
      color: var(--color-p1);
    }

    .priority-badge.p2 {
      background: rgba(255, 165, 2, 0.15);
      color: var(--color-p2);
    }

    .priority-badge.p3 {
      background: rgba(52, 152, 219, 0.15);
      color: var(--color-p3);
    }

    /* ====== Progress Bar ====== */
    .progress-container {
      margin: 10px 0;
    }

    .progress-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .progress-label {
      font-size: 11px;
      color: var(--color-text-muted);
      font-weight: 500;
    }

    .progress-value {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--color-text-secondary);
      font-weight: 600;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--color-border);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 2px;
      transition: width var(--transition-slow);
      min-width: 0;
    }

    .column.todo .progress-fill { background: var(--color-todo); }
    .column.in-progress .progress-fill { background: var(--color-inprogress); }
    .column.done .progress-fill { background: var(--color-done); }

    /* ====== Task List ====== */
    .task-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 8px;
    }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 5px 6px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      line-height: 1.5;
      color: var(--color-text-secondary);
      transition: background var(--transition-fast);
    }

    .task-item:hover {
      background: var(--color-surface-hover);
    }

    .task-checkbox {
      flex-shrink: 0;
      width: 15px;
      height: 15px;
      border-radius: 3px;
      border: 1.5px solid var(--color-border);
      margin-top: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .task-checkbox.checked {
      background: var(--color-done);
      border-color: var(--color-done);
    }

    .task-checkbox.checked::after {
      content: '';
      display: block;
      width: 4px;
      height: 7px;
      border: solid white;
      border-width: 0 1.5px 1.5px 0;
      transform: rotate(45deg) translate(-0.5px, -0.5px);
    }

    .task-item.checked .task-description {
      text-decoration: line-through;
      color: var(--color-text-muted);
    }

    .task-id {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--color-text-muted);
      flex-shrink: 0;
      margin-top: 1px;
    }

    .task-description {
      flex: 1;
      transition: color var(--transition-fast);
    }

    /* ====== Empty State ====== */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      grid-column: 1 / -1;
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      background: var(--color-surface-elevated);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 6px;
    }

    .empty-state-text {
      font-size: 13px;
      color: var(--color-text-muted);
      max-width: 300px;
    }

    .column-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 16px;
      color: var(--color-text-muted);
      font-size: 12px;
      font-style: italic;
      flex: 1;
    }

    /* ====== Completion Celebration ====== */
    .card.just-completed {
      animation: celebrateComplete 0.6s ease-out;
    }

    @keyframes celebrateComplete {
      0% { transform: scale(1); }
      30% { transform: scale(1.03); box-shadow: 0 0 20px rgba(39, 201, 63, 0.3); }
      100% { transform: scale(1); }
    }

    /* ====== Loading ====== */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      grid-column: 1 / -1;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== Responsive ====== */
    @media (max-width: 1024px) {
      .board {
        min-width: unset;
        grid-template-columns: 1fr;
      }
      .column { min-height: 100px; }
    }

    /* ====== Theme Toggle ====== */
    .theme-toggle {
      background: var(--color-surface-elevated);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      transition: border-color var(--transition-fast), background var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      border-color: var(--color-accent);
      background: var(--color-surface-hover);
    }

    .theme-toggle:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    /* ====== Collapsible Task List ====== */
    .task-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      padding: 4px 6px;
      border: none;
      background: none;
      color: var(--color-text-muted);
      font-size: 11px;
      font-family: var(--font-sans);
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: color var(--transition-fast), background var(--transition-fast);
      width: 100%;
      text-align: left;
    }

    .task-toggle:hover {
      color: var(--color-text-secondary);
      background: var(--color-surface-hover);
    }

    .task-toggle-icon {
      transition: transform var(--transition-fast);
      font-size: 9px;
    }

    .task-toggle-icon.expanded {
      transform: rotate(90deg);
    }

    .task-list {
      overflow: hidden;
      transition: max-height var(--transition-normal), opacity var(--transition-fast);
    }

    .task-list.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
    }

    .task-list.expanded {
      max-height: 2000px;
      opacity: 1;
    }

    /* ====== Pipeline Bar ====== */
    .pipeline-bar {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 14px 28px;
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      position: sticky;
      top: 58px;
      z-index: 90;
    }

    .pipeline-node {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast);
      flex: 0 1 96px;
      width: 96px;
      min-width: 40px;
      position: relative;
      border: 1px solid var(--color-border-subtle);
      background: transparent;
      overflow: hidden;
    }

    .pipeline-node:hover {
      background: var(--color-surface-hover);
      transform: translateY(-1px);
    }

    .pipeline-node:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    .pipeline-node.active {
      border: 2px solid var(--color-accent);
      background: var(--color-surface-elevated);
    }

    .pipeline-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      transition: all var(--transition-normal);
    }

    .pipeline-dot.not_started {
      background: var(--color-surface-elevated);
      border: 2px solid var(--color-border);
      color: var(--color-text-muted);
    }

    .pipeline-dot.in_progress {
      background: rgba(245, 166, 35, 0.15);
      border: 2px solid var(--color-inprogress);
      color: var(--color-inprogress);
    }

    .pipeline-dot.complete {
      background: rgba(39, 201, 63, 0.15);
      border: 2px solid var(--color-done);
      color: var(--color-done);
    }

    .pipeline-dot.skipped {
      background: var(--color-surface-elevated);
      border: 2px dashed var(--color-text-muted);
      color: var(--color-text-muted);
    }

    .pipeline-dot.available {
      background: rgba(59, 130, 246, 0.12);
      border: 2px solid var(--color-accent);
      color: var(--color-accent);
    }

    .pipeline-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .pipeline-progress {
      font-size: 9px;
      font-family: var(--font-mono);
      color: var(--color-text-muted);
      min-height: 13px;
    }

    .pipeline-connector {
      flex: 1 1 24px;
      min-width: 4px;
      height: 2px;
      background: var(--color-border);
      margin-top: -16px;
    }

    .pipeline-connector.complete {
      background: var(--color-done);
    }

    .pipeline-node.optional .pipeline-label {
      font-style: italic;
      opacity: 0.8;
    }

    /* ====== Content Area ====== */
    .content-area {
      flex: 1;
      min-height: 0;
    }

    .placeholder-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 20px;
      text-align: center;
    }

    .placeholder-view-icon {
      width: 56px;
      height: 56px;
      background: var(--color-surface-elevated);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 16px;
    }

    .placeholder-view-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 6px;
    }

    .placeholder-view-text {
      font-size: 13px;
      color: var(--color-text-muted);
      max-width: 360px;
    }

    /* ====== Constitution Tab ====== */
    .constitution-view {
      padding: 24px 28px;
    }

    .constitution-layout {
      display: flex;
      gap: 32px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .constitution-layout { flex-direction: column; }
    }

    .constitution-left {
      flex: 0 0 280px;
    }

    .constitution-right {
      flex: 1 1 300px;
      min-width: 0;
    }

    .constitution-summary {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 20px;
    }

    .constitution-summary-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text);
      border-bottom: 1px solid var(--color-border-subtle);
    }

    .constitution-summary-item:last-child { border-bottom: none; }

    .constitution-summary-item .principle-num {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--color-text-muted);
      flex-shrink: 0;
      width: 24px;
    }

    .constitution-summary-item .level-badge {
      font-size: 9px;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 3px;
      text-transform: uppercase;
      margin-left: auto;
      flex-shrink: 0;
      letter-spacing: 0.3px;
    }

    .level-badge.must { background: rgba(59, 130, 246, 0.15); color: var(--color-accent); }
    .level-badge.should { background: rgba(245, 166, 35, 0.15); color: var(--color-inprogress); }
    .level-badge.may { background: rgba(107, 113, 137, 0.15); color: var(--color-text-muted); }

    .constitution-body {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    @media (max-width: 768px) {
      .constitution-body { flex-direction: column; }
    }

    .radar-container {
      flex: 0 0 auto;
      width: 100%;
      max-width: 280px;
    }

    .radar-container svg {
      width: 100%;
      height: auto;
    }

    .radar-axis {
      cursor: pointer;
      transition: opacity var(--transition-fast);
    }

    .radar-axis:hover { opacity: 0.8; }
    .radar-axis:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }

    .detail-card {
      flex: 1 1 280px;
      background: var(--color-surface-elevated);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 20px;
      animation: cardEnter 0.25s ease;
    }

    .detail-card h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--color-text);
    }

    .detail-card .detail-level {
      margin-bottom: 12px;
    }

    .detail-card .detail-text {
      font-size: 13px;
      line-height: 1.6;
      color: var(--color-text-secondary);
      margin-bottom: 16px;
    }

    .detail-card .detail-rationale {
      font-size: 12px;
      line-height: 1.5;
      color: var(--color-text-muted);
      padding-top: 12px;
      border-top: 1px solid var(--color-border-subtle);
    }

    .detail-card .detail-rationale strong {
      color: var(--color-text-secondary);
    }

    .amendment-timeline {
      margin-top: 24px;
      padding: 16px 0;
      border-top: 1px solid var(--color-border-subtle);
    }

    .amendment-timeline-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-muted);
      margin-bottom: 8px;
    }

    .amendment-timeline-content {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    .amendment-timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-accent);
      flex-shrink: 0;
    }

    .amendment-timeline-line {
      flex: 1;
      height: 2px;
      background: var(--color-border);
    }

    /* ====== Scrollbar ====== */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--color-text-muted); }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header" role="banner">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon" aria-hidden="true">D</div>
        <span>IIKit Dashboard</span>
      </div>
      <div class="feature-selector" role="navigation" aria-label="Feature selector">
        <select id="featureSelect" aria-label="Select feature to display" tabindex="0">
          <option value="">Loading features...</option>
        </select>
      </div>
    </div>
    <div class="header-right">
      <div id="integrityBadge" class="integrity-badge missing" role="status" aria-label="Test integrity status">
        <span class="integrity-dot" aria-hidden="true"></span>
        <span class="integrity-text">Checking...</span>
      </div>
      <button id="themeToggle" class="theme-toggle" aria-label="Toggle light/dark theme" title="Toggle theme" tabindex="0">
        <span id="themeIcon">&#9790;</span>
      </button>
      <div id="activityIndicator" class="activity-indicator idle" role="status" aria-label="Agent activity: idle" title="Agent idle — no recent file changes"></div>
    </div>
  </header>

  <!-- Pipeline Bar -->
  <nav id="pipelineBar" class="pipeline-bar" role="navigation" aria-label="IIKit workflow pipeline">
  </nav>

  <!-- Content Area -->
  <main class="content-area" role="main">
    <div id="contentArea">
      <div class="board-container">
        <div id="board" class="board" role="region" aria-label="Kanban board">
          <div class="loading" id="loadingState">
            <div class="loading-spinner" aria-label="Loading board data"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function() {
      'use strict';

      // ====== State ======
      let currentFeature = null;
      let currentBoard = null;
      let currentPipeline = null;
      let activeTab = null;
      let ws = null;
      let reconnectTimer = null;
      let previousCardColumns = {}; // Track card positions for animations

      // ====== DOM References ======
      const boardEl = document.getElementById('board');
      const featureSelect = document.getElementById('featureSelect');
      const integrityBadge = document.getElementById('integrityBadge');
      const activityIndicator = document.getElementById('activityIndicator');
      let lastActivityTime = 0;
      const ACTIVITY_TIMEOUT = 10000; // 10 seconds
      const loadingState = document.getElementById('loadingState');
      const pipelineBar = document.getElementById('pipelineBar');
      const contentArea = document.getElementById('contentArea');

      // ====== Pipeline ======
      const PHASE_ICONS = {
        not_started: '',
        in_progress: '&#9654;',
        complete: '&#10003;',
        skipped: '&#8212;',
        available: '&#9679;'
      };

      function renderPipeline(pipeline) {
        if (!pipeline || !pipeline.phases) return;
        currentPipeline = pipeline;

        pipelineBar.innerHTML = '';

        pipeline.phases.forEach((phase, i) => {
          // Add connector before each node (except the first)
          if (i > 0) {
            const connector = document.createElement('div');
            connector.className = 'pipeline-connector';
            // Color connector green if previous phase is complete
            const prevPhase = pipeline.phases[i - 1];
            if (prevPhase.status === 'complete') {
              connector.classList.add('complete');
            }
            pipelineBar.appendChild(connector);
          }

          const node = document.createElement('button');
          node.className = 'pipeline-node' + (phase.optional ? ' optional' : '');
          if (activeTab === phase.id) node.classList.add('active');
          node.setAttribute('tabindex', '0');
          if (activeTab === phase.id) node.setAttribute('aria-current', 'true');

          node.innerHTML = `
            <div class="pipeline-dot ${phase.status}">${PHASE_ICONS[phase.status] || ''}</div>
            <span class="pipeline-label">${escapeHtml(phase.name)}</span>
            <span class="pipeline-progress">${phase.progress || ''}</span>
          `;

          node.addEventListener('click', () => switchTab(phase.id));
          pipelineBar.appendChild(node);
        });
      }

      function switchTab(phaseId) {
        activeTab = phaseId;
        // Re-render pipeline to update active state
        if (currentPipeline) renderPipeline(currentPipeline);

        if (phaseId === 'implement') {
          renderBoardView();
        } else if (phaseId === 'constitution') {
          renderConstitutionView();
        } else {
          renderPlaceholderView(phaseId);
        }
      }

      function renderBoardView() {
        contentArea.innerHTML = `
          <div class="board-container">
            <div id="board" class="board" role="region" aria-label="Kanban board"></div>
          </div>`;
        // Re-assign boardEl reference
        const newBoardEl = document.getElementById('board');
        if (currentBoard) {
          renderBoardInto(newBoardEl, currentBoard);
        }
      }

      function renderPlaceholderView(phaseId) {
        const phaseNames = {
          constitution: 'Constitution', spec: 'Specification', clarify: 'Clarification',
          plan: 'Plan', checklist: 'Checklist', testify: 'Test Specs',
          tasks: 'Tasks', analyze: 'Analysis', implement: 'Implementation'
        };
        const name = phaseNames[phaseId] || phaseId;
        contentArea.innerHTML = `
          <div class="placeholder-view">
            <div class="placeholder-view-title">${name} View</div>
            <div class="placeholder-view-text">This phase visualization is coming soon. It will be available in a future update.</div>
          </div>`;
      }

      // ====== Constitution View ======
      let currentConstitution = null;
      let selectedPrinciple = null;

      async function renderConstitutionView() {
        try {
          if (!currentConstitution) {
            const res = await fetch('/api/constitution');
            currentConstitution = await res.json();
          }
          renderConstitutionContent(currentConstitution);
        } catch (err) {
          console.error('Failed to load constitution:', err);
          contentArea.innerHTML = '<div class="placeholder-view"><div class="placeholder-view-title">Failed to load constitution</div></div>';
        }
      }

      function renderConstitutionContent(data) {
        if (!data || !data.exists) {
          contentArea.innerHTML = `
            <div class="placeholder-view">
              <div class="placeholder-view-title">No Constitution Found</div>
              <div class="placeholder-view-text">Run /iikit-00-constitution to define your project's governance principles.</div>
            </div>`;
          return;
        }

        const principles = data.principles;
        if (principles.length === 0) {
          contentArea.innerHTML = `
            <div class="placeholder-view">
              <div class="placeholder-view-title">No Principles Found</div>
              <div class="placeholder-view-text">Your CONSTITUTION.md exists but has no parseable principles.</div>
            </div>`;
          return;
        }

        // Summary list
        const summaryHtml = principles.map(p =>
          `<div class="constitution-summary-item"><span class="principle-num">${escapeHtml(p.number)}.</span> ${escapeHtml(p.name)} <span class="level-badge ${p.level.toLowerCase()}">${p.level}</span></div>`
        ).join('');

        // Radar chart SVG
        const radarSvg = generateRadarSVG(principles);

        // Detail card — only shown when a principle is selected
        const detailHtml = selectedPrinciple
          ? `<div class="detail-card">${renderDetailCard(selectedPrinciple)}</div>`
          : '';

        // Timeline
        const timelineHtml = data.version ? renderTimeline(data.version) : '';

        contentArea.innerHTML = `
          <div class="constitution-view">
            <div class="constitution-layout">
              <div class="constitution-left">
                <div class="radar-container">${radarSvg}</div>
                ${timelineHtml}
              </div>
              <div class="constitution-right">
                <div class="constitution-summary">${summaryHtml}</div>
                ${detailHtml}
              </div>
            </div>
          </div>`;

        // Attach click handlers to radar axes
        principles.forEach((p, i) => {
          const axisEl = document.getElementById(`radar-axis-${i}`);
          if (axisEl) {
            axisEl.addEventListener('click', () => { selectedPrinciple = p; renderConstitutionContent(data); });
            axisEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectedPrinciple = p; renderConstitutionContent(data); } });
          }
        });
      }

      function generateRadarSVG(principles) {
        const size = 260;
        const cx = size / 2;
        const cy = size / 2;
        const maxR = size / 2 - 36;
        const levels = { 'MUST': 1, 'SHOULD': 0.66, 'MAY': 0.33 };
        const n = principles.length;
        const angleStep = (2 * Math.PI) / n;
        const startAngle = -Math.PI / 2; // Start from top

        // Ring lines (33%, 66%, 100%)
        let rings = '';
        [0.33, 0.66, 1].forEach(pct => {
          const r = maxR * pct;
          const points = [];
          for (let i = 0; i < n; i++) {
            const angle = startAngle + i * angleStep;
            points.push(`${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`);
          }
          rings += `<polygon points="${points.join(' ')}" fill="none" stroke="var(--color-border)" stroke-width="1" opacity="0.5"/>`;
        });

        // Axis lines from center to outer edge
        let axes = '';
        for (let i = 0; i < n; i++) {
          const angle = startAngle + i * angleStep;
          const x2 = cx + maxR * Math.cos(angle);
          const y2 = cy + maxR * Math.sin(angle);
          axes += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="var(--color-border)" stroke-width="1" opacity="0.3"/>`;
        }

        // Filled polygon connecting principle values
        const valuePoints = principles.map((p, i) => {
          const angle = startAngle + i * angleStep;
          const r = maxR * (levels[p.level] || 0.66);
          return `${cx + r * Math.cos(angle)},${cy + r * Math.sin(angle)}`;
        });
        const polygon = `<polygon points="${valuePoints.join(' ')}" fill="var(--color-accent)" fill-opacity="0.2" stroke="var(--color-accent)" stroke-width="2"/>`;

        // Value dots and clickable areas
        let dots = '';
        principles.forEach((p, i) => {
          const angle = startAngle + i * angleStep;
          const r = maxR * (levels[p.level] || 0.66);
          const x = cx + r * Math.cos(angle);
          const y = cy + r * Math.sin(angle);

          // Label position (pushed further out)
          const labelR = maxR + 16;
          const lx = cx + labelR * Math.cos(angle);
          const ly = cy + labelR * Math.sin(angle);
          const anchor = Math.abs(Math.cos(angle)) < 0.1 ? 'middle' : Math.cos(angle) > 0 ? 'start' : 'end';

          const isSelected = selectedPrinciple && selectedPrinciple.number === p.number;

          dots += `
            <g id="radar-axis-${i}" class="radar-axis" tabindex="0" role="button"
               aria-label="${escapeHtml(p.name)} (${p.level})">
              <circle cx="${x}" cy="${y}" r="${isSelected ? 7 : 5}" fill="var(--color-accent)" stroke="${isSelected ? 'var(--color-text)' : 'none'}" stroke-width="2"/>
              <circle cx="${x}" cy="${y}" r="16" fill="transparent"/>
              <text x="${lx}" y="${ly}" text-anchor="${anchor}" dominant-baseline="middle"
                    font-size="9" font-weight="600" fill="var(--color-text-secondary)"
                    style="letter-spacing: 0.2px;">${escapeHtml(p.name)}</text>
            </g>`;
        });

        const ariaLabel = `Radar chart showing ${n} constitution principles: ${principles.map(p => p.name + ' (' + p.level + ')').join(', ')}`;

        return `<svg viewBox="0 0 ${size} ${size}" role="img" aria-label="${escapeHtml(ariaLabel)}">${rings}${axes}${polygon}${dots}</svg>`;
      }

      function renderDetailCard(principle) {
        return `
          <h3>${escapeHtml(principle.number)}. ${escapeHtml(principle.name)}</h3>
          <div class="detail-level"><span class="level-badge ${principle.level.toLowerCase()}">${principle.level}</span></div>
          <div class="detail-text">${escapeHtml(principle.text).replace(/\n/g, '<br>')}</div>
          ${principle.rationale ? `<div class="detail-rationale"><strong>Rationale:</strong> ${escapeHtml(principle.rationale)}</div>` : ''}`;
      }

      function renderTimeline(version) {
        return `
          <div class="amendment-timeline">
            <div class="amendment-timeline-label">Amendment History</div>
            <div class="amendment-timeline-content">
              <div class="amendment-timeline-dot"></div>
              <span>v${escapeHtml(version.version)} &mdash; Ratified ${escapeHtml(version.ratified)}</span>
              ${version.ratified !== version.lastAmended ? `
                <div class="amendment-timeline-line"></div>
                <div class="amendment-timeline-dot"></div>
                <span>Amended ${escapeHtml(version.lastAmended)}</span>
              ` : ''}
            </div>
          </div>`;
      }

      function selectDefaultTab(pipeline) {
        if (!pipeline || !pipeline.phases) return 'implement';

        const impl = pipeline.phases.find(p => p.id === 'implement');
        if (impl && (impl.status === 'in_progress' || impl.status === 'complete')) return 'implement';

        // Walk backward through all phases to find last completed
        const allPhases = ['constitution', 'spec', 'clarify', 'plan', 'checklist', 'testify', 'tasks', 'analyze', 'implement'];
        for (let i = allPhases.length - 1; i >= 0; i--) {
          const phase = pipeline.phases.find(p => p.id === allPhases[i]);
          if (phase && phase.status === 'complete') {
            return allPhases[i];
          }
        }

        return 'implement';
      }

      async function loadPipeline(featureId) {
        try {
          const res = await fetch(`/api/pipeline/${featureId}`);
          if (!res.ok) return;
          const pipeline = await res.json();
          currentPipeline = pipeline;

          if (!activeTab) {
            activeTab = selectDefaultTab(pipeline);
          }

          renderPipeline(pipeline);
          switchTab(activeTab);
        } catch (err) {
          console.error('Failed to load pipeline:', err);
        }
      }

      // ====== Feature Loading ======
      async function loadFeatures() {
        try {
          const res = await fetch('/api/features');
          const features = await res.json();
          updateFeatureSelector(features);

          if (features.length > 0 && !currentFeature) {
            currentFeature = features[features.length - 1].id;
            featureSelect.value = currentFeature;
            loadPipeline(currentFeature);
            loadBoard(currentFeature);
          } else if (features.length === 0) {
            showEmptyState();
          }
        } catch (err) {
          console.error('Failed to load features:', err);
        }
      }

      function updateFeatureSelector(features) {
        featureSelect.innerHTML = '';
        if (features.length === 0) {
          featureSelect.innerHTML = '<option value="">No features found</option>';
          return;
        }
        for (const f of features) {
          const opt = document.createElement('option');
          opt.value = f.id;
          opt.textContent = `${f.id} — ${f.name} (${f.progress})`;
          featureSelect.appendChild(opt);
        }
      }

      featureSelect.addEventListener('change', () => {
        const val = featureSelect.value;
        if (val && val !== currentFeature) {
          currentFeature = val;
          previousCardColumns = {};
          activeTab = null; // Reset tab selection for new feature
          loadPipeline(val);
          loadBoard(val);
          // Resubscribe WebSocket
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'subscribe', feature: val }));
          }
        }
      });

      featureSelect.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
          // Default browser behavior handles this
          return;
        }
      });

      // ====== Board Loading ======
      async function loadBoard(featureId) {
        try {
          showLoading();
          const res = await fetch(`/api/board/${featureId}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const board = await res.json();
          currentBoard = board;
          renderBoard(board);
          updateIntegrity(board.integrity);
        } catch (err) {
          console.error('Failed to load board:', err);
          showEmptyState('Failed to load board data');
        }
      }

      function showLoading() {
        boardEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      }

      function showEmptyState(msg) {
        boardEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#9776;</div>
            <div class="empty-state-title">${msg || 'No features found'}</div>
            <div class="empty-state-text">Create a feature with spec.md and tasks.md in your specs/ directory to get started.</div>
          </div>`;
      }

      // ====== Board Rendering ======
      function renderBoardInto(targetEl, board) {
        if (!board || !targetEl) return;

        const columns = [
          { key: 'todo', label: 'Todo', cards: board.todo || [] },
          { key: 'in_progress', label: 'In Progress', cards: board.in_progress || [] },
          { key: 'done', label: 'Done', cards: board.done || [] }
        ];

        // Build new card positions
        const newCardColumns = {};
        for (const col of columns) {
          for (const card of col.cards) {
            newCardColumns[card.id] = col.key;
          }
        }

        // Detect moved cards
        const movedCards = {};
        for (const [cardId, newCol] of Object.entries(newCardColumns)) {
          const oldCol = previousCardColumns[cardId];
          if (oldCol && oldCol !== newCol) {
            movedCards[cardId] = { from: oldCol, to: newCol };
          }
        }

        targetEl.innerHTML = '';

        for (const col of columns) {
          const colEl = document.createElement('div');
          colEl.className = `column ${col.key === 'in_progress' ? 'in-progress' : col.key}`;
          colEl.setAttribute('role', 'region');
          colEl.setAttribute('aria-label', `${col.label} column with ${col.cards.length} stories`);

          colEl.innerHTML = `
            <div class="column-header">
              <div class="column-title">
                <span class="column-dot" aria-hidden="true"></span>
                ${col.label}
              </div>
              <span class="column-count">${col.cards.length}</span>
            </div>
            <div class="column-body" id="col-${col.key}"></div>`;

          targetEl.appendChild(colEl);

          const bodyEl = colEl.querySelector('.column-body');

          if (col.cards.length === 0) {
            bodyEl.innerHTML = '<div class="column-empty">No stories</div>';
          } else {
            for (const card of col.cards) {
              const cardEl = createCardElement(card, col.key);

              // Add animation class if card just moved here
              if (movedCards[card.id]) {
                cardEl.classList.add('entering');
                if (movedCards[card.id].to === 'done') {
                  cardEl.classList.add('just-completed');
                }
                // Remove animation class after it completes
                cardEl.addEventListener('animationend', () => {
                  cardEl.classList.remove('entering', 'just-completed');
                }, { once: true });
              }

              bodyEl.appendChild(cardEl);
            }
          }
        }

        previousCardColumns = newCardColumns;
      }

      function renderBoard(board) {
        const targetEl = document.getElementById('board');
        if (targetEl) renderBoardInto(targetEl, board);
      }

      function createCardElement(card, columnKey) {
        const el = document.createElement('div');
        el.className = 'card';
        el.setAttribute('data-card-id', card.id);
        el.setAttribute('role', 'article');
        el.setAttribute('aria-label', `${card.title} - ${card.priority} - ${card.progress} tasks complete`);

        const progressParts = card.progress.split('/');
        const checked = parseInt(progressParts[0], 10);
        const total = parseInt(progressParts[1], 10);
        const pct = total > 0 ? Math.round((checked / total) * 100) : 0;

        const priorityClass = card.priority ? card.priority.toLowerCase() : 'p3';

        el.innerHTML = `
          <div class="card-id">${card.id}</div>
          <div class="card-header">
            <div class="card-title" title="${escapeHtml(card.title)}">${escapeHtml(card.title)}</div>
            <span class="priority-badge ${priorityClass}" aria-label="Priority ${card.priority}">${card.priority}</span>
          </div>
          <div class="progress-container">
            <div class="progress-info">
              <span class="progress-label">Progress</span>
              <span class="progress-value">${card.progress} (${pct}%)</span>
            </div>
            <div class="progress-bar" role="progressbar" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-fill" style="width: ${pct}%"></div>
            </div>
          </div>
          <button class="task-toggle" onclick="toggleTasks(this)" aria-expanded="false" aria-controls="tasks-${card.id}">
            <span class="task-toggle-icon" aria-hidden="true">&#9654;</span>
            ${(card.tasks || []).length} tasks
          </button>
          <ul class="task-list collapsed" id="tasks-${card.id}" aria-label="Tasks for ${card.id}">
            ${(card.tasks || []).map(t => `
              <li class="task-item ${t.checked ? 'checked' : ''}">
                <span class="task-checkbox ${t.checked ? 'checked' : ''}" aria-hidden="true"></span>
                <span class="task-id">${t.id}</span>
                <span class="task-description">${escapeHtml(t.description)}</span>
              </li>
            `).join('')}
          </ul>`;

        return el;
      }

      function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }

      // ====== Integrity Badge ======
      function updateIntegrity(integrity) {
        if (!integrity) return;
        const badge = integrityBadge;
        const textEl = badge.querySelector('.integrity-text');

        badge.className = `integrity-badge ${integrity.status}`;

        switch (integrity.status) {
          case 'valid':
            textEl.textContent = 'Verified';
            badge.setAttribute('aria-label', 'Test integrity: verified');
            badge.title = 'Assertion hash matches stored hash';
            break;
          case 'tampered':
            textEl.textContent = 'Tampered';
            badge.setAttribute('aria-label', 'Test integrity: tampered - assertions may have been modified');
            badge.title = 'Assertion hash does not match stored hash!';
            break;
          case 'missing':
            textEl.textContent = 'Missing';
            badge.setAttribute('aria-label', 'Test integrity: no hash data available');
            badge.title = 'No test-specs.md or context.json found';
            break;
        }
      }

      // ====== WebSocket ======
      function connectWebSocket() {
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const url = `${protocol}//${location.host}`;

        // connecting

        try {
          ws = new WebSocket(url);
        } catch (err) {
          // disconnected
          scheduleReconnect();
          return;
        }

        ws.onopen = () => {
          // connected
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }
          // Subscribe to current feature
          if (currentFeature) {
            ws.send(JSON.stringify({ type: 'subscribe', feature: currentFeature }));
          }
        };

        ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            handleMessage(msg);
          } catch (err) {
            console.error('Failed to parse WebSocket message:', err);
          }
        };

        ws.onclose = () => {
          // disconnected
          ws = null;
          scheduleReconnect();
        };

        ws.onerror = () => {
          // onclose will fire after onerror
        };
      }

      function markActivity() {
        lastActivityTime = Date.now();
        if (!activityIndicator.classList.contains('active')) {
          activityIndicator.classList.remove('idle');
          activityIndicator.classList.add('active');
          activityIndicator.title = 'Agent active \u2014 files changing';
          activityIndicator.setAttribute('aria-label', 'Agent activity: active');
        }
      }

      // Check activity every 2 seconds
      setInterval(() => {
        if (lastActivityTime > 0 && Date.now() - lastActivityTime > ACTIVITY_TIMEOUT) {
          if (activityIndicator.classList.contains('active')) {
            activityIndicator.classList.remove('active');
            activityIndicator.classList.add('idle');
            activityIndicator.title = 'Agent idle \u2014 no recent file changes';
            activityIndicator.setAttribute('aria-label', 'Agent activity: idle');
          }
        }
      }, 2000);

      function handleMessage(msg) {
        markActivity();
        switch (msg.type) {
          case 'board_update':
            if (msg.feature === currentFeature && msg.board) {
              currentBoard = msg.board;
              if (activeTab === 'implement') {
                renderBoard(msg.board);
              }
              updateIntegrity(msg.board.integrity);
            }
            break;

          case 'pipeline_update':
            if (msg.feature === currentFeature && msg.pipeline) {
              currentPipeline = msg.pipeline;
              renderPipeline(msg.pipeline);
            }
            break;

          case 'constitution_update':
            if (msg.constitution) {
              currentConstitution = msg.constitution;
              if (activeTab === 'constitution') {
                renderConstitutionContent(msg.constitution);
              }
            }
            break;

          case 'features_update':
            if (msg.features) {
              updateFeatureSelector(msg.features);
              if (currentFeature) {
                featureSelect.value = currentFeature;
              }
            }
            break;
        }
      }

      function scheduleReconnect() {
        if (reconnectTimer) return;
        reconnectTimer = setTimeout(() => {
          reconnectTimer = null;
          connectWebSocket();
        }, 3000);
      }


      // ====== Theme Toggle ======
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const html = document.documentElement;

      function getPreferredTheme() {
        const stored = localStorage.getItem('iikit-theme');
        if (stored) return stored;
        return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
      }

      function applyTheme(theme) {
        if (theme === 'light') {
          html.setAttribute('data-theme', 'light');
          themeIcon.textContent = '\u2600'; // sun
          themeToggle.setAttribute('aria-label', 'Switch to dark theme');
        } else {
          html.removeAttribute('data-theme');
          themeIcon.textContent = '\u263E'; // moon
          themeToggle.setAttribute('aria-label', 'Switch to light theme');
        }
        localStorage.setItem('iikit-theme', theme);
      }

      themeToggle.addEventListener('click', () => {
        const current = html.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
        applyTheme(current === 'light' ? 'dark' : 'light');
      });

      // Listen for OS theme changes
      window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
        if (!localStorage.getItem('iikit-theme')) {
          applyTheme(e.matches ? 'light' : 'dark');
        }
      });

      // Apply on load
      applyTheme(getPreferredTheme());

      // ====== Init ======
      loadFeatures();
      connectWebSocket();
    })();

    // ====== Task List Toggle (global, called from onclick) ======
    function toggleTasks(btn) {
      const list = btn.nextElementSibling;
      const icon = btn.querySelector('.task-toggle-icon');
      const isCollapsed = list.classList.contains('collapsed');

      if (isCollapsed) {
        list.classList.remove('collapsed');
        list.classList.add('expanded');
        icon.classList.add('expanded');
        btn.setAttribute('aria-expanded', 'true');
      } else {
        list.classList.remove('expanded');
        list.classList.add('collapsed');
        icon.classList.remove('expanded');
        btn.setAttribute('aria-expanded', 'false');
      }
    }
  </script>
</body>
</html>
